name: Build iOS (Unsigned for Sideloading)

# Single-path iOS build pipeline:
# Expo prebuild -> xcodebuild (unsigned) -> IPA artifact -> rolling release (ios-latest)
#
# Triggers:
#   - workflow_dispatch: manual run from UI
#   - pull_request: build check on PRs that touch mobile/
#   - push to main: automatically build and release when mobile/ changes
on:
  workflow_dispatch:

  pull_request:
    branches: [main]
    paths:
      - "mobile/**"
      - ".github/workflows/build-ios-simple.yml"

  push:
    branches: [main]
    paths:
      - "mobile/**"
      - ".github/workflows/build-ios-simple.yml"

concurrency:
  group: ios-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Unsigned iOS
    # Keep this pinned for predictable Xcode behavior.
    # macos-latest can work, but may break unexpectedly when runner/Xcode changes.
    runs-on: macos-15
    timeout-minutes: 60

    permissions:
      contents: write

    steps:
      # 1) Fetch repository source
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Install Node runtime used by Expo/React Native toolchain
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: mobile/package-lock.json

      # 3) Inject runtime API URL into mobile/.env for JS bundling
      - name: Configure mobile build environment
        env:
          EXPO_PUBLIC_API_URL: ${{ vars.EXPO_PUBLIC_API_URL != '' && vars.EXPO_PUBLIC_API_URL || secrets.EXPO_PUBLIC_API_URL || '' }}
        run: |
          set -euo pipefail
          if [ -z "$EXPO_PUBLIC_API_URL" ]; then
            echo "❌ Missing EXPO_PUBLIC_API_URL"
            echo "Set repository variable or secret EXPO_PUBLIC_API_URL before running this workflow."
            exit 1
          fi

          {
            echo "# Generated by CI"
            echo "EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL"
          } > mobile/.env

          echo "✅ mobile/.env generated for Expo bundle"

      # 4) Install JS dependencies
      - name: Install dependencies
        working-directory: mobile
        run: npm ci

      # 5) Generate ios/ folder from Expo config
      - name: Generate iOS project (Expo prebuild)
        working-directory: mobile
        run: npx expo prebuild --platform ios --clean

      # 6) Install native iOS dependencies
      - name: Install CocoaPods
        working-directory: mobile/ios
        run: pod install

      # 7) Disable Pod signing so build can produce unsigned app bundle
      - name: Disable Pod code signing
        working-directory: mobile/ios
        run: |
          gem install xcodeproj
          ruby << 'RUBY_SCRIPT'
            require 'xcodeproj'

            project_path = 'Pods/Pods.xcodeproj'
            project = Xcodeproj::Project.open(project_path)

            project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                config.build_settings['CODE_SIGN_IDENTITY'] = ''
                config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
              end
            end

            project.save
            puts "✅ Code signing disabled for #{project.targets.count} Pod targets"
          RUBY_SCRIPT

      # 8) Compile Release app and locate generated .app
      - name: Build with xcodebuild
        working-directory: mobile/ios
        run: |
          set -euo pipefail

          WORKSPACE=$(ls -d *.xcworkspace | head -1)
          if [ -z "$WORKSPACE" ]; then
            echo "❌ No .xcworkspace found"
            exit 1
          fi

          WORKSPACE_NAME=$(basename "$WORKSPACE" .xcworkspace)
          ALL_SCHEMES=$(xcodebuild -workspace "$WORKSPACE" -list 2>/dev/null | \
            sed -n '/Schemes:/,/^$/p' | \
            grep -v 'Schemes:' | \
            grep -v '^$' | \
            sed 's/^[[:space:]]*//')

          # Prefer scheme with workspace name, then filter known dependency schemes.
          SCHEME=$(echo "$ALL_SCHEMES" | grep -i "^${WORKSPACE_NAME}$" | head -1)
          if [ -z "$SCHEME" ]; then
            SCHEME=$(echo "$ALL_SCHEMES" | \
              grep -v -i '^Pods-' | \
              grep -v -i '^EX' | \
              grep -v -i '^RCT' | \
              grep -v -i '^React' | \
              grep -v -i 'Tests$' | \
              head -1)
          fi

          if [ -z "$SCHEME" ]; then
            echo "❌ Could not find app scheme"
            echo "Schemes found:"
            echo "$ALL_SCHEMES"
            exit 1
          fi

          echo "Using workspace: $WORKSPACE"
          echo "Using scheme: $SCHEME"

          set -o pipefail
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            build 2>&1 | tee build.log

          APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" -type d 2>/dev/null | grep -v "Pods" | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "❌ No .app bundle produced"
            find build/Build/Products -maxdepth 3 -type d | sort
            exit 1
          fi

          echo "✅ Found app bundle: $APP_PATH"
          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"

      # 9) Convert .app to unsigned .ipa and export path/name for next steps
      - name: Package IPA
        working-directory: mobile/ios
        run: |
          set -euo pipefail

          if [ -z "${{ env.APP_PATH }}" ]; then
            echo "❌ APP_PATH is empty"
            exit 1
          fi

          rm -rf Payload
          mkdir -p Payload
          cp -R "${{ env.APP_PATH }}" Payload/

          APP_NAME=$(basename "${{ env.APP_PATH }}" .app)

          # Build the IPA filename based on trigger type
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Sanitize branch name for use in filename
            BRANCH_RAW="${{ github.head_ref }}"
            BRANCH=$(echo "$BRANCH_RAW" | tr -cd '[:alnum:]._-' | cut -c1-60)
            IPA_NAME="${APP_NAME}-${BRANCH}-unsigned.ipa"
          else
            IPA_NAME="${APP_NAME}-unsigned.ipa"
          fi

          zip -r -9 "$IPA_NAME" Payload/

          mv "$IPA_NAME" "$GITHUB_WORKSPACE/$IPA_NAME"
          echo "IPA_PATH=$GITHUB_WORKSPACE/$IPA_NAME" >> "$GITHUB_ENV"
          echo "IPA_NAME=$IPA_NAME" >> "$GITHUB_ENV"

          echo "✅ Created $IPA_NAME"
          du -h "$GITHUB_WORKSPACE/$IPA_NAME"

      # 10) Keep workflow artifact for easy download from run page
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: ${{ env.IPA_PATH }}
          retention-days: 30
          if-no-files-found: error

      # 11) Update rolling GitHub release tag with latest IPA
      - name: Publish latest IPA release
        if: success() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          TAG="ios-latest"
          RELEASE_TITLE="Latest iOS Unsigned Build"
          RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases/tag/${TAG}"

          gh api -X PATCH "repos/${{ github.repository }}/git/refs/tags/${TAG}" \
            -f sha="${{ github.sha }}" \
            -F force=true \
            >/dev/null 2>&1 || \
          gh api -X POST "repos/${{ github.repository }}/git/refs" \
            -f ref="refs/tags/${TAG}" \
            -f sha="${{ github.sha }}" \
            >/dev/null

          NOTES=$(cat <<EOF
          Automated unsigned iOS build from commit ${{ github.sha }}.

          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF
          )

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release edit "$TAG" --title "$RELEASE_TITLE" --notes "$NOTES" --prerelease
          else
            gh release create "$TAG" --title "$RELEASE_TITLE" --notes "$NOTES" --prerelease
          fi

          gh release upload "$TAG" "${{ env.IPA_PATH }}#${{ env.IPA_NAME }}" --clobber
          echo "RELEASE_URL=$RELEASE_URL" >> "$GITHUB_ENV"
          echo "✅ Updated rolling release: $RELEASE_URL"

      # 12) Upload logs for post-failure debugging
      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: mobile/ios/build.log
          retention-days: 7
          if-no-files-found: warn

      # 13) Write short summary card in Actions UI
      - name: Build summary
        if: success() && github.event_name == 'workflow_dispatch'
        run: |
          IPA_SIZE=$(du -h "${{ env.IPA_PATH }}" | cut -f1)

          echo "## iOS Build Successful" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| IPA | ${{ env.IPA_NAME }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Size | $IPA_SIZE |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact | ios-unsigned-ipa |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Release | ${{ env.RELEASE_URL }} |" >> "$GITHUB_STEP_SUMMARY"

      - name: PR check summary
        if: success() && github.event_name == 'pull_request'
        run: |
          IPA_SIZE=$(du -h "${{ env.IPA_PATH }}" | cut -f1)
          echo "## ✅ iOS Build Passed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Branch | ${{ github.head_ref }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| IPA | ${{ env.IPA_NAME }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Size | $IPA_SIZE |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact | ios-unsigned-ipa |" >> "$GITHUB_STEP_SUMMARY"

      - name: Push summary
        if: success() && github.event_name == 'push'
        run: |
          IPA_SIZE=$(du -h "${{ env.IPA_PATH }}" | cut -f1)
          echo "## ✅ iOS Build & Release Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| IPA | ${{ env.IPA_NAME }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Size | $IPA_SIZE |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact | ios-unsigned-ipa |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Release | ${{ env.RELEASE_URL }} |" >> "$GITHUB_STEP_SUMMARY"
