name: Build iOS (Unsigned for Sideloading)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  issue_comment:
    types: [created]

concurrency:
  group: ios-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Unsigned iOS
    # Run on PR comments containing "build ios" OR pushes to main branch
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'build ios'))
    runs-on: macos-15
    timeout-minutes: 60

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Handle PR comment triggers
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Add reaction to comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            })

      - name: Get PR branch
        if: github.event_name == 'issue_comment'
        id: pr-branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Setup
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && steps.pr-branch.outputs.ref || github.ref }}

      - name: Select Xcode & check SDK
        run: |
          echo "============================================"
          echo "Xcode Setup"
          echo "============================================"

          # Find highest available Xcode
          XCODE_PATH=$(ls -d /Applications/Xcode_*.app 2>/dev/null | sort -V | tail -1)
          echo "Using: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"

          echo ""
          xcodebuild -version

          echo ""
          echo "============================================"
          echo "Available SDKs"
          echo "============================================"
          xcodebuild -showsdks

          echo ""
          echo "Verifying iphoneos SDK..."
          if xcodebuild -showsdks | grep -q iphoneos; then
            echo "‚úÖ iphoneos SDK found"
          else
            echo "‚ùå iphoneos SDK not found!"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: mobile/package-lock.json

      - name: Install dependencies
        working-directory: mobile
        run: npm ci

      - name: Install missing peer deps
        working-directory: mobile
        run: |
          echo "Installing react-native-svg peer dependency..."
          npx expo install react-native-svg

      - name: Expo prebuild
        working-directory: mobile
        run: |
          echo "============================================"
          echo "Generating native iOS project"
          echo "============================================"
          npx expo prebuild --platform ios --clean
          echo "‚úÖ Native project generated"

      - name: Install CocoaPods
        working-directory: mobile/ios
        run: |
          echo "============================================"
          echo "Installing CocoaPods dependencies"
          echo "============================================"
          pod install
          echo "‚úÖ Pods installed"

      - name: Disable code signing for all targets
        working-directory: mobile/ios
        run: |
          echo "============================================"
          echo "Disabling code signing for all Pod targets"
          echo "============================================"

          # Install xcodeproj gem for project manipulation
          gem install xcodeproj

          # Use Ruby with xcodeproj to modify all targets
          ruby << 'RUBY_SCRIPT'
            require 'xcodeproj'

            # Open the Pods project
            project_path = 'Pods/Pods.xcodeproj'
            project = Xcodeproj::Project.open(project_path)

            # Disable code signing for all targets
            project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                config.build_settings['CODE_SIGN_IDENTITY'] = ''
                config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
              end
            end

            # Save the project
            project.save

            puts "‚úÖ Code signing disabled for #{project.targets.count} targets"
          RUBY_SCRIPT

      - name: Build with xcodebuild
        working-directory: mobile/ios
        run: |
          echo "============================================"
          echo "Building iOS app"
          echo "============================================"

          WORKSPACE=$(ls -d *.xcworkspace | head -1)
          if [ -z "$WORKSPACE" ]; then
            echo "‚ùå No .xcworkspace found in mobile/ios"
            ls -la
            exit 1
          fi

          echo "Using workspace: $WORKSPACE"

          echo ""
          echo "Available schemes:"
          xcodebuild -workspace "$WORKSPACE" -list

          if [ -n "${APP_SCHEME:-}" ]; then
            SCHEME="$APP_SCHEME"
            echo ""
            echo "Using manually specified scheme: $SCHEME"
          else
            WORKSPACE_NAME=$(basename "$WORKSPACE" .xcworkspace)
            echo ""
            echo "Auto-detecting scheme for workspace: $WORKSPACE_NAME"

            ALL_SCHEMES=$(xcodebuild -workspace "$WORKSPACE" -list 2>/dev/null | \
                         sed -n '/Schemes:/,/^$/p' | \
                         grep -v 'Schemes:' | \
                         grep -v '^$' | \
                         sed 's/^[[:space:]]*//')

            echo ""
            echo "All schemes found:"
            echo "$ALL_SCHEMES"

            # Prefer scheme that matches workspace name exactly (case-insensitive)
            SCHEME=$(echo "$ALL_SCHEMES" | grep -i "^${WORKSPACE_NAME}$" | head -1)

            # Fallback: filter out known dependency/library schemes
            if [ -z "$SCHEME" ]; then
              SCHEME=$(echo "$ALL_SCHEMES" | \
                       grep -v -i '^Pods-' | \
                       grep -v -i '^EX' | \
                       grep -v -i '^RCT' | \
                       grep -v -i '^React' | \
                       grep -v -i 'Tests$' | \
                       head -1)
            fi
          fi

          echo "Using scheme: $SCHEME"

          if [ -z "$SCHEME" ]; then
            echo "‚ùå No scheme found!"
            echo "Set APP_SCHEME to your app target if auto-detection fails."
            exit 1
          fi

          echo ""
          echo "Starting build..."
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            build 2>&1 | tee build.log

          echo ""
          echo "============================================"
          echo "Looking for .app bundle"
          echo "============================================"

          APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" -type d 2>/dev/null | grep -v "Pods" | head -1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find build -name "*.app" -type d 2>/dev/null | grep -v "Pods" | grep -v ".xcarchive" | head -1)
          fi

          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Build completed but no .app bundle was found."
            echo "Build products:"
            find build -type d -maxdepth 4
            exit 1
          fi

          echo "‚úÖ Found .app bundle: $APP_PATH"
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV

      - name: Package IPA
        working-directory: mobile/ios
        run: |
          echo "============================================"
          echo "Packaging .ipa"
          echo "============================================"

          if [ -z "${{ env.APP_PATH }}" ]; then
            echo "‚ùå APP_PATH is empty. Build step did not export an .app path."
            exit 1
          fi

          echo "Found: ${{ env.APP_PATH }}"

          rm -rf Payload
          mkdir -p Payload
          cp -R "${{ env.APP_PATH }}" Payload/

          echo ""
          echo "Creating .ipa..."
          zip -r -9 MovieManager-unsigned.ipa Payload/

          echo ""
          echo "============================================"
          echo "‚úÖ IPA created"
          echo "Size: $(du -h MovieManager-unsigned.ipa | cut -f1)"
          echo "============================================"

          # Move to mobile/ for upload step path (mobile/MovieManager-unsigned.ipa)
          mv MovieManager-unsigned.ipa ../

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: |
            mobile/MovieManager-unsigned.ipa
            mobile/ios/MovieManager-unsigned.ipa
            MovieManager-unsigned.ipa
          retention-days: 30
          if-no-files-found: error

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: mobile/ios/build.log
          retention-days: 7
          if-no-files-found: warn

      - name: Build summary
        if: success()
        run: |
          IPA_FILE=""
          for p in mobile/MovieManager-unsigned.ipa mobile/ios/MovieManager-unsigned.ipa MovieManager-unsigned.ipa; do
            if [ -f "$p" ]; then
              IPA_FILE="$p"
              break
            fi
          done

          if [ -z "$IPA_FILE" ]; then
            echo "‚ùå No IPA file found for summary"
            exit 1
          fi

          IPA_SIZE=$(du -h "$IPA_FILE" | cut -f1)

          echo "## ‚úÖ iOS Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **IPA File** | $IPA_FILE |" >> $GITHUB_STEP_SUMMARY
          echo "| **Size** | $IPA_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| **Signing** | Unsigned (for sideloading) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì± Installation" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`ios-unsigned-ipa\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Install with **SideStore** or **AltStore**" >> $GITHUB_STEP_SUMMARY
          echo "3. The app will be re-signed with your free Apple ID" >> $GITHUB_STEP_SUMMARY

      - name: Comment build result
        if: success() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ iOS build completed!\n\nüì¶ Download \`ios-unsigned-ipa\` from [workflow artifacts](${runUrl}).\n\nüì± Install with **SideStore** or **AltStore**.`
            })

      - name: Comment build failure
        if: failure() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå Build failed. Check [workflow logs](${runUrl}).`
            })
