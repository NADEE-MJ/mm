name: Build iOS App

# Trigger on PR comments containing "build ios"
on:
  issue_comment:
    types: [created]

jobs:
  build-ios:
    # Only run on PR comments (not issues) that contain "build ios"
    if: github.event.issue.pull_request && contains(github.event.comment.body, 'build ios')
    runs-on: macos-latest
    
    # Set minimal permissions for security
    permissions:
      contents: read        # Read repository contents
      pull-requests: write  # Comment on PRs
      issues: write         # Add reactions to comments

    steps:
      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            })

      - name: Get PR branch
        id: pr-branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);

      # Security Note: We checkout the PR branch to build the React Native app.
      # The build itself happens on EAS Build's infrastructure, not directly on this runner.
      # Only maintainers or trusted contributors should trigger this action.
      # Consider adding a check for author association if needed:
      # if: github.event.issue.author_association == 'OWNER' || github.event.issue.author_association == 'MEMBER'
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-branch.outputs.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Install dependencies
        working-directory: mobile
        run: npm ci

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build iOS app (unsigned)
        working-directory: mobile
        run: |
          # Create eas.json if it doesn't exist
          if [ ! -f eas.json ]; then
            cat > eas.json << 'EOF'
          {
            "cli": {
              "version": ">= 5.9.0"
            },
            "build": {
              "preview": {
                "ios": {
                  "simulator": false,
                  "buildType": "archive",
                  "distribution": "internal"
                }
              },
              "unsigned": {
                "ios": {
                  "simulator": false,
                  "buildType": "archive",
                  "distribution": "internal",
                  "autoIncrement": true
                }
              }
            }
          }
          EOF
          fi
          
          # Build the app
          eas build --platform ios --profile unsigned --non-interactive --no-wait
          
          # Wait a moment for the build to be registered
          sleep 5

      - name: Wait for build and download
        working-directory: mobile
        run: |
          # Wait for the build to complete and get the artifact URL
          echo "Build submitted. Checking build status..."
          
          # Get the latest build ID
          BUILD_ID=$(eas build:list --platform=ios --limit=1 --json --non-interactive | jq -r '.[0].id')
          echo "Build ID: $BUILD_ID"
          
          # Wait for build to complete (max 30 minutes)
          TIMEOUT=1800
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(eas build:view $BUILD_ID --json --non-interactive | jq -r '.status')
            echo "Build status: $STATUS (${ELAPSED}s elapsed)"
            
            if [ "$STATUS" = "FINISHED" ]; then
              echo "Build completed successfully!"
              ARTIFACT_URL=$(eas build:view $BUILD_ID --json --non-interactive | jq -r '.artifacts.buildUrl')
              echo "Artifact URL: $ARTIFACT_URL"
              
              # Download the IPA
              curl -L -o app.ipa "$ARTIFACT_URL"
              echo "IPA downloaded successfully"
              break
            elif [ "$STATUS" = "ERRORED" ] || [ "$STATUS" = "CANCELED" ]; then
              echo "Build failed with status: $STATUS"
              exit 1
            fi
            
            sleep 30
            ELAPSED=$((ELAPSED + 30))
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "Build timed out after 30 minutes"
            exit 1
          fi

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-unsigned
          path: mobile/app.ipa
          retention-days: 30

      - name: Comment build result
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ iOS build completed successfully!\n\nüì¶ Download the unsigned IPA from the [workflow artifacts](${runUrl}).`
            })

      - name: Comment build failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå iOS build failed. Check the [workflow logs](${runUrl}) for details.`
            })
