# =============================================================================
# GitHub Actions: Build Unsigned iOS .ipa (No Paid Apple Developer Account)
# =============================================================================
# This workflow builds Movie Manager for iOS without code signing,
# then packages it into an .ipa suitable for re-signing with SideStore/AltStore.
#
# APPROACH: Build with CODE_SIGNING_ALLOWED=NO â†’ package .app â†’ create .ipa
# =============================================================================

name: Build iOS (Unsigned for Sideloading)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger
  issue_comment:
    types: [created]

# Cancel in-progress runs for the same branch
concurrency:
  group: ios-build-${{ github.ref }}
  cancel-in-progress: true

env:
  # â”€â”€â”€ Customize these for your project â”€â”€â”€
  APP_CONFIGURATION: "Release"       # Build configuration
  EXPO_PROJECT_DIR: "mobile"         # Mobile app directory
  # â”€â”€â”€ Xcode version â”€â”€â”€
  # GitHub Actions macOS runners come with multiple Xcode versions.
  # As of early 2026, macos-15 runners include Xcode 26.x.
  # Check: https://github.com/actions/runner-images
  XCODE_VERSION: "26.0"

jobs:
  build-unsigned-ipa:
    name: Build Unsigned .ipa
    # Run on PR comments containing "build ios" OR pushes to main branch
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'build ios'))
    runs-on: macos-15  # Use macos-15 for Xcode 26 support
    timeout-minutes: 60

    # Set minimal permissions for security
    permissions:
      contents: read        # Read repository contents
      pull-requests: write  # Comment on PRs
      issues: write         # Add reactions to comments

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 0. Add reaction to comment (if triggered by comment)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Add reaction to comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            })

      - name: Get PR branch
        if: github.event_name == 'issue_comment'
        id: pr-branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Checkout
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && steps.pr-branch.outputs.ref || github.ref }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Select Xcode version
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: |
          # List available Xcode versions for debugging
          echo "Available Xcode versions:"
          ls /Applications/ | grep Xcode || true

          # Select the desired Xcode version
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

          # Verify
          xcodebuild -version
          echo "Selected Xcode: $(xcode-select -p)"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Set up Node.js
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: mobile/package-lock.json

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Install JS dependencies
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        working-directory: ${{ env.EXPO_PROJECT_DIR }}
        run: npm ci

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Generate native iOS project (Expo prebuild)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Expo prebuild (generate native project)
        working-directory: ${{ env.EXPO_PROJECT_DIR }}
        run: |
          echo "Running expo prebuild to generate native iOS project..."
          npx expo prebuild --platform ios --clean
          echo "âœ… Native iOS project generated"
          ls -la ios/

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Patch Xcode project to disable code signing
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Disable code signing in Xcode project
        working-directory: ${{ env.EXPO_PROJECT_DIR }}/ios
        run: |
          # Create a temporary Ruby script to modify the Xcode project
          # This ensures code signing is disabled at the project level too
          cat > disable_signing.rb << 'RUBY_SCRIPT'
          require 'xcodeproj'

          project_path = Dir.glob("*.xcodeproj").first
          unless project_path
            puts "âŒ No .xcodeproj found"
            exit 1
          end

          project = Xcodeproj::Project.open(project_path)

          project.targets.each do |target|
            target.build_configurations.each do |config|
              config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
              config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
              config.build_settings['CODE_SIGN_IDENTITY'] = ''
              config.build_settings['CODE_SIGN_ENTITLEMENTS'] = ''
              config.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = ''
              config.build_settings['DEVELOPMENT_TEAM'] = ''
              # Ensure it still produces a valid .app bundle
              config.build_settings['ENABLE_BITCODE'] = 'NO'
            end
          end

          project.save
          puts "âœ… Code signing disabled for all targets"
          RUBY_SCRIPT

          # Install xcodeproj gem if needed and run the script
          gem install xcodeproj --no-document 2>/dev/null || true
          ruby disable_signing.rb

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. Install CocoaPods
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install CocoaPods dependencies
        working-directory: ${{ env.EXPO_PROJECT_DIR }}/ios
        run: |
          echo "Installing CocoaPods..."
          pod install --repo-update
        env:
          COCOAPODS_DISABLE_STATS: "true"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8. Build the .app (unsigned)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build unsigned .app
        working-directory: ${{ env.EXPO_PROJECT_DIR }}/ios
        run: |
          # Determine workspace and scheme names
          WORKSPACE=$(ls -d *.xcworkspace | head -1)
          echo "Using workspace: $WORKSPACE"

          # List available schemes
          echo "Available schemes:"
          xcodebuild -workspace "$WORKSPACE" -list

          # Get the first scheme name (Expo typically generates one matching the project)
          SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list 2>/dev/null | sed -n '/Schemes:/,/^$/p' | grep -v 'Schemes:' | head -1 | xargs)
          echo "Using scheme: $SCHEME"

          if [ -z "$SCHEME" ]; then
            echo "âŒ Error: No scheme found in workspace!"
            exit 1
          fi

          # Build for generic iOS device (arm64) without signing
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration "${{ env.APP_CONFIGURATION }}" \
            -destination "generic/platform=iOS" \
            -derivedDataPath build \
            -allowProvisioningUpdates=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            build \
            | tee build.log

          # Verify .app was produced
          APP_PATH=$(find build -name "*.app" -type d | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Build failed: no .app found"
            echo "Last 50 lines of build log:"
            tail -50 build.log
            exit 1
          fi

          echo "âœ… Built: $APP_PATH"
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9. Package .app into .ipa
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Package .app into .ipa
        working-directory: ${{ env.EXPO_PROJECT_DIR }}/ios
        run: |
          # Create the Payload directory structure that .ipa requires
          mkdir -p Payload
          cp -R "${{ env.APP_PATH }}" Payload/

          # Show what we're packaging
          echo "ğŸ“¦ Payload contents:"
          ls -la Payload/

          # Get the app name for the .ipa filename
          APP_NAME=$(basename "${{ env.APP_PATH }}" .app)
          IPA_NAME="${APP_NAME}-unsigned.ipa"

          # Create the .ipa (it's just a zip with Payload/ inside)
          zip -r -9 "$IPA_NAME" Payload/

          # Verify
          echo "âœ… Created: $IPA_NAME ($(du -h "$IPA_NAME" | cut -f1))"

          # Move to a consistent location for upload
          mv "$IPA_NAME" "$GITHUB_WORKSPACE/$IPA_NAME"
          echo "IPA_PATH=$GITHUB_WORKSPACE/$IPA_NAME" >> $GITHUB_ENV
          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 10. Upload .ipa as artifact
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload unsigned .ipa artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: ${{ env.IPA_PATH }}
          retention-days: 30
          if-no-files-found: error

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 11. Upload build logs (for debugging failures)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ${{ env.EXPO_PROJECT_DIR }}/ios/build.log
          retention-days: 7

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 12. Build summary
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build summary
        if: success()
        run: |
          echo "## âœ… iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **IPA File** | \`${{ env.IPA_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Signing** | Unsigned (for sideloading) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Configuration** | ${{ env.APP_CONFIGURATION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Xcode** | ${{ env.XCODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Bundle ID** | com.moviemanager.mobile |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“± Next Steps to Install on Your Device" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`ios-unsigned-ipa\` artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Transfer the .ipa file to your iOS device" >> $GITHUB_STEP_SUMMARY
          echo "3. Install using **SideStore** or **AltStore**:" >> $GITHUB_STEP_SUMMARY
          echo "   - These tools will re-sign the app with your free Apple ID" >> $GITHUB_STEP_SUMMARY
          echo "   - No paid developer account needed!" >> $GITHUB_STEP_SUMMARY
          echo "4. The app will be installed and ready to use" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Note**: Apps installed via free Apple ID expire after 7 days and need to be re-signed." >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 13. Comment build result on PR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment build result
        if: success() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… iOS unsigned build completed successfully!\n\nğŸ“¦ Download the \`ios-unsigned-ipa\` artifact from the [workflow run](${runUrl}).\n\nğŸ“± **This IPA is unsigned** and ready to be re-signed with **SideStore** or **AltStore**.\n\n### Installation Steps:\n1. Download the .ipa file\n2. Transfer to your iOS device\n3. Open in SideStore/AltStore\n4. The app will be re-signed with your free Apple ID and installed\n\nâ° **No paid Apple Developer account needed!** Apps expire after 7 days and need to be re-signed.`
            })

      - name: Comment build failure
        if: failure() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âŒ iOS build failed. Check the [workflow logs](${runUrl}) for details.`
            })
