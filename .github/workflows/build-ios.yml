# =============================================================================
# GitHub Actions: Build Unsigned iOS .ipa (No Paid Apple Developer Account)
# =============================================================================
# This workflow builds Movie Manager for iOS without code signing,
# then packages it into an .ipa suitable for re-signing with SideStore/AltStore.
#
# APPROACH: Build with CODE_SIGNING_ALLOWED=NO â†’ package .app â†’ create .ipa
# =============================================================================

name: Build iOS (Unsigned for Sideloading)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger
  issue_comment:
    types: [created]

# Cancel in-progress runs for the same branch
concurrency:
  group: ios-build-${{ github.ref }}
  cancel-in-progress: true

env:
  # â”€â”€â”€ Customize these for your project â”€â”€â”€
  APP_CONFIGURATION: "Release"       # Build configuration
  EXPO_PROJECT_DIR: "mobile"         # Mobile app directory
  # â”€â”€â”€ Scheme name (optional override) â”€â”€â”€
  # Leave empty for auto-detection, or set to your app's scheme name
  # Example: APP_SCHEME: "MovieManager"
  APP_SCHEME: ""  # Auto-detect by default

jobs:
  build-unsigned-ipa:
    name: Build Unsigned .ipa
    # Run on PR comments containing "build ios" OR pushes to main branch
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'build ios'))
    runs-on: macos-latest  # Use latest available macOS runner
    timeout-minutes: 60

    # Set minimal permissions for security
    permissions:
      contents: read        # Read repository contents
      pull-requests: write  # Comment on PRs
      issues: write         # Add reactions to comments

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 0. Add reaction to comment (if triggered by comment)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Add reaction to comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            })

      - name: Get PR branch
        if: github.event_name == 'issue_comment'
        id: pr-branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Checkout
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && steps.pr-branch.outputs.ref || github.ref }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Verify Xcode and iOS SDK
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify Xcode and iOS SDK
        run: |
          echo "============================================"
          echo "Xcode Version"
          echo "============================================"
          xcodebuild -version
          echo ""
          echo "Path: $(xcode-select -p)"

          echo ""
          echo "============================================"
          echo "Available SDKs"
          echo "============================================"
          xcodebuild -showsdks

          echo ""
          echo "Checking for iOS SDK..."
          if xcodebuild -showsdks | grep -q iphoneos; then
            IOS_SDK=$(xcodebuild -showsdks | grep iphoneos | head -1 | awk '{print $2}')
            echo "âœ… iOS SDK is available: $IOS_SDK"
          else
            echo "âŒ No iOS SDK found!"
            exit 1
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Set up Node.js
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: mobile/package-lock.json

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Install JS dependencies
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        working-directory: ${{ env.EXPO_PROJECT_DIR }}
        run: npm ci

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4a. Configure Expo environment variables
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure Expo environment
        working-directory: ${{ env.EXPO_PROJECT_DIR }}
        env:
          MOBILE_ENV_FILE: ${{ vars.MOBILE_ENV_FILE != '' && vars.MOBILE_ENV_FILE || secrets.MOBILE_ENV_FILE || '' }}
          EXPO_PUBLIC_API_URL: ${{ vars.EXPO_PUBLIC_API_URL != '' && vars.EXPO_PUBLIC_API_URL || secrets.EXPO_PUBLIC_API_URL || '' }}
        run: |
          echo "============================================"
          echo "Configuring Expo environment"
          echo "============================================"

          if [ -n "$MOBILE_ENV_FILE" ]; then
            printf '%s\n' "$MOBILE_ENV_FILE" > .env
            echo "âœ… Loaded environment from MOBILE_ENV_FILE"
          else
            API_URL="$EXPO_PUBLIC_API_URL"
            if [ -z "$API_URL" ]; then
              API_URL="https://api.moviemanager.com/api"
              echo "âš ï¸ EXPO_PUBLIC_API_URL not set in GitHub vars/secrets; using production fallback"
            else
              echo "âœ… Loaded EXPO_PUBLIC_API_URL from GitHub vars/secrets"
            fi

            {
              echo "# Generated by CI"
              echo "EXPO_PUBLIC_API_URL=$API_URL"
            } > .env
          fi

          if ! grep -q '^EXPO_PUBLIC_API_URL=' .env; then
            echo "âŒ EXPO_PUBLIC_API_URL is missing in generated .env"
            exit 1
          fi

          echo "âœ… EXPO_PUBLIC_API_URL is configured for this build"
          EXPO_PUBLIC_API_URL_VALUE=$(grep '^EXPO_PUBLIC_API_URL=' .env | head -1 | cut -d= -f2-)
          echo "EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL_VALUE" >> "$GITHUB_ENV"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. Generate native iOS project (Expo prebuild)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Expo prebuild (generate native project)
        working-directory: ${{ env.EXPO_PROJECT_DIR }}
        run: |
          echo "Running expo prebuild to generate native iOS project..."
          npx expo prebuild --platform ios --clean
          echo "âœ… Native iOS project generated"
          ls -la ios/

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5a. Debug - Show workspace and schemes
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Debug workspace and schemes
        working-directory: ${{ env.EXPO_PROJECT_DIR }}/ios
        run: |
          echo "============================================"
          echo "Workspace and Scheme Information"
          echo "============================================"
          echo ""
          echo "Workspace files:"
          ls -la *.xcworkspace 2>/dev/null || echo "âŒ No workspace found"
          echo ""
          echo "Project files:"
          ls -la *.xcodeproj 2>/dev/null || echo "âŒ No xcodeproj found"
          echo ""
          WORKSPACE=$(ls -d *.xcworkspace | head -1)
          if [ -n "$WORKSPACE" ]; then
            echo "Schemes in $WORKSPACE:"
            xcodebuild -workspace "$WORKSPACE" -list
          fi
          echo ""
          echo "============================================"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. Patch Xcode project (fix build cycle + disable signing)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Patch Xcode project
        working-directory: ${{ env.EXPO_PROJECT_DIR }}/ios
        run: |
          # Create a Ruby script to fix the build cycle and disable code signing
          cat > fix_project.rb << 'RUBY_SCRIPT'
          require 'xcodeproj'

          project_path = Dir.glob("*.xcodeproj").first
          unless project_path
            puts "âŒ No .xcodeproj found"
            exit 1
          end

          project = Xcodeproj::Project.open(project_path)

          # Fix 1: Fix circular dependency in Expo Configure project phase
          project.targets.each do |target|
            next unless target.name == 'MovieManager' || target.name == 'moviemanager'

            # Find the Expo Configure project phase
            expo_phase = target.shell_script_build_phases.find do |phase|
              phase.name == '[Expo] Configure project'
            end

            if expo_phase
              # Disable dependency analysis to break the cycle
              # This tells Xcode to always run this phase, not to analyze dependencies
              expo_phase.always_out_of_date = true

              # Also clear input/output file lists that cause the cycle
              expo_phase.input_paths = []
              expo_phase.output_paths = []
              expo_phase.input_file_list_paths = []
              expo_phase.output_file_list_paths = []

              # Move to beginning for good measure
              target.build_phases.delete(expo_phase)
              target.build_phases.insert(0, expo_phase)

              puts "âœ… Fixed '[Expo] Configure project' phase (disabled dependency analysis)"
            end
          end

          # Fix 2: Disable code signing for all targets
          project.targets.each do |target|
            target.build_configurations.each do |config|
              config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
              config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
              config.build_settings['CODE_SIGN_IDENTITY'] = ''
              config.build_settings['CODE_SIGN_ENTITLEMENTS'] = ''
              config.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = ''
              config.build_settings['DEVELOPMENT_TEAM'] = ''
              config.build_settings['ENABLE_BITCODE'] = 'NO'
            end
          end

          project.save
          puts "âœ… Code signing disabled for all targets"
          puts "âœ… Build cycle fixed"
          RUBY_SCRIPT

          # Install xcodeproj gem if needed and run the script
          gem install xcodeproj --no-document 2>/dev/null || true
          ruby fix_project.rb

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. Install CocoaPods
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install CocoaPods dependencies
        working-directory: ${{ env.EXPO_PROJECT_DIR }}/ios
        run: |
          echo "Installing CocoaPods..."
          pod install --repo-update
        env:
          COCOAPODS_DISABLE_STATS: "true"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8. Build the .app (unsigned)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build unsigned .app
        working-directory: ${{ env.EXPO_PROJECT_DIR }}/ios
        run: |
          # Determine workspace and scheme names
          WORKSPACE=$(ls -d *.xcworkspace | head -1)
          echo "============================================"
          echo "Using workspace: $WORKSPACE"
          echo "============================================"

          # List available schemes
          echo ""
          echo "Available schemes:"
          xcodebuild -workspace "$WORKSPACE" -list

          # Check if APP_SCHEME is manually set
          if [ -n "${{ env.APP_SCHEME }}" ]; then
            SCHEME="${{ env.APP_SCHEME }}"
            echo ""
            echo "Using manually specified scheme: $SCHEME"
          else
            # Auto-detect the scheme
            echo ""
            echo "Auto-detecting scheme..."

            # Get the workspace base name (e.g., "moviemanager" from "moviemanager.xcworkspace")
            WORKSPACE_NAME=$(basename "$WORKSPACE" .xcworkspace)
            echo "Workspace base name: $WORKSPACE_NAME"

            # Get all schemes, one per line
            ALL_SCHEMES=$(xcodebuild -workspace "$WORKSPACE" -list 2>/dev/null | \
                          sed -n '/Schemes:/,/^$/p' | \
                          grep -v 'Schemes:' | \
                          grep -v '^$' | \
                          sed 's/^[[:space:]]*//')

            echo ""
            echo "All schemes found:"
            echo "$ALL_SCHEMES"

            # Try to find a scheme matching the workspace name (case-insensitive)
            SCHEME=$(echo "$ALL_SCHEMES" | grep -i "^${WORKSPACE_NAME}$" | head -1)

            # If no exact match, try to find the main app scheme by filtering out known dependencies
            if [ -z "$SCHEME" ]; then
              echo ""
              echo "âš ï¸  No scheme matching workspace name, filtering out dependency schemes..."
              SCHEME=$(echo "$ALL_SCHEMES" | \
                       grep -v -i '^Pods-' | \
                       grep -v -i '^EX' | \
                       grep -v -i '^RCT' | \
                       grep -v -i '^React' | \
                       grep -v -i 'Tests$' | \
                       head -1)
            fi

            if [ -z "$SCHEME" ]; then
              echo ""
              echo "âŒ Error: Could not auto-detect app scheme!"
              echo ""
              echo "All schemes available:"
              echo "$ALL_SCHEMES"
              echo ""
              echo "Please set APP_SCHEME environment variable in workflow to your app's scheme name."
              echo "Example: APP_SCHEME: \"MovieManager\""
              exit 1
            fi
          fi

          echo ""
          echo "============================================"
          echo "Selected scheme: $SCHEME"
          echo "============================================"

          # Build for iOS device using -sdk (more reliable than -destination)
          echo ""
          echo "============================================"
          echo "Starting build..."
          echo "SDK: iphoneos (latest available)"
          echo "============================================"
          set -o pipefail

          # Build with xcodebuild, ignoring dependency cycle warnings
          set +e  # Don't exit on error
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration "${{ env.APP_CONFIGURATION }}" \
            -sdk iphoneos \
            -derivedDataPath build \
            -skipMacroValidation \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            build \
            2>&1 | tee build.log

          BUILD_EXIT_CODE=$?
          set -e  # Re-enable exit on error

          # Check if build succeeded
          # Note: We ignore exit code 65 if the .app was actually produced
          # (exit code 65 can be a cycle warning, not an actual failure)
          echo ""
          echo "Build exit code: $BUILD_EXIT_CODE"

          if [ $BUILD_EXIT_CODE -ne 0 ] && [ $BUILD_EXIT_CODE -ne 65 ]; then
            echo "âŒ xcodebuild failed with exit code $BUILD_EXIT_CODE"
            echo "Last 100 lines of build log:"
            tail -100 build.log
            exit 1
          fi

          # For exit code 65, check if .app was actually produced
          if [ $BUILD_EXIT_CODE -eq 65 ]; then
            echo "âš ï¸  Build returned exit code 65 (may be cycle warning)"
            echo "Checking if .app was actually produced..."

            TEMP_APP_PATH=$(find build/Build/Products/${{ env.APP_CONFIGURATION }}-iphoneos -name "*.app" -type d 2>/dev/null | grep -v "Pods" | head -1)
            if [ -z "$TEMP_APP_PATH" ]; then
              echo "âŒ Exit code 65 AND no .app found - build actually failed"
              echo "Last 100 lines of build log:"
              tail -100 build.log
              exit 1
            else
              echo "âœ… .app was produced despite exit code 65 - continuing"
            fi
          fi

          echo ""
          echo "============================================"
          echo "Build completed, searching for .app bundle..."
          echo "============================================"

          # Debug: show build products structure
          echo ""
          echo "Build products directory structure:"
          find build/Build/Products -maxdepth 3 -type d 2>/dev/null | sort || true

          # Search for .app bundle in the expected location
          echo ""
          echo "Searching for .app bundles:"
          find build/Build/Products -name "*.app" -type d 2>/dev/null || true

          # Find the .app - it should be in Release-iphoneos for Release builds
          APP_PATH=$(find build/Build/Products/${{ env.APP_CONFIGURATION }}-iphoneos -name "*.app" -type d 2>/dev/null | grep -v "Pods" | head -1)

          # Fallback: search anywhere in build directory
          if [ -z "$APP_PATH" ]; then
            echo ""
            echo "âš ï¸  Not found in expected location, searching entire build directory..."
            APP_PATH=$(find build -name "*.app" -type d 2>/dev/null | grep -v "Pods" | grep -v ".xcarchive" | head -1)
          fi

          if [ -z "$APP_PATH" ]; then
            echo ""
            echo "âŒ Build succeeded but no .app bundle found!"
            echo ""
            echo "Checked locations:"
            echo "  - build/Build/Products/${{ env.APP_CONFIGURATION }}-iphoneos/*.app"
            echo "  - build/**/*.app (excluding Pods)"
            echo ""
            echo "Actual build products:"
            find build/Build/Products -type f -o -type d -name "*.app" | head -50
            echo ""
            echo "Last 50 lines of build log:"
            tail -50 build.log
            exit 1
          fi

          echo ""
          echo "============================================"
          echo "âœ… Found .app bundle: $APP_PATH"
          echo "============================================"
          ls -lh "$APP_PATH"

          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9. Package .app into .ipa
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Package .app into .ipa
        working-directory: ${{ env.EXPO_PROJECT_DIR }}/ios
        run: |
          echo "============================================"
          echo "Packaging .app into .ipa"
          echo "============================================"
          echo ""
          echo "App bundle path: ${{ env.APP_PATH }}"

          # Create the Payload directory structure that .ipa requires
          mkdir -p Payload

          # Copy the .app bundle into Payload/
          cp -R "${{ env.APP_PATH }}" Payload/

          # Show what we're packaging
          echo ""
          echo "ğŸ“¦ Payload contents:"
          ls -lah Payload/
          du -sh Payload/

          # Get the app name for the .ipa filename
          APP_NAME=$(basename "${{ env.APP_PATH }}" .app)
          IPA_NAME="${APP_NAME}-unsigned.ipa"

          echo ""
          echo "Creating IPA: $IPA_NAME"

          # Create the .ipa (it's just a zip with Payload/ inside)
          zip -r -9 "$IPA_NAME" Payload/

          # Verify
          echo ""
          echo "============================================"
          echo "âœ… Created: $IPA_NAME"
          echo "Size: $(du -h "$IPA_NAME" | cut -f1)"
          echo "============================================"
          ls -lh "$IPA_NAME"

          # Move to a consistent location for upload
          mv "$IPA_NAME" "$GITHUB_WORKSPACE/$IPA_NAME"
          echo "IPA_PATH=$GITHUB_WORKSPACE/$IPA_NAME" >> $GITHUB_ENV
          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV

          echo ""
          echo "IPA ready for upload: $GITHUB_WORKSPACE/$IPA_NAME"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 10. Upload .ipa as artifact
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload unsigned .ipa artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: ${{ env.IPA_PATH }}
          retention-days: 30
          if-no-files-found: error

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 11. Upload build logs (for debugging failures)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ${{ env.EXPO_PROJECT_DIR }}/ios/build.log
          retention-days: 7

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 12. Build summary
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build summary
        if: success()
        run: |
          echo "## âœ… iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **IPA File** | \`${{ env.IPA_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Signing** | Unsigned (for sideloading) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Configuration** | ${{ env.APP_CONFIGURATION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Xcode** | ${{ env.XCODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Bundle ID** | com.moviemanager.mobile |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“± Next Steps to Install on Your Device" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`ios-unsigned-ipa\` artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Transfer the .ipa file to your iOS device" >> $GITHUB_STEP_SUMMARY
          echo "3. Install using **SideStore** or **AltStore**:" >> $GITHUB_STEP_SUMMARY
          echo "   - These tools will re-sign the app with your free Apple ID" >> $GITHUB_STEP_SUMMARY
          echo "   - No paid developer account needed!" >> $GITHUB_STEP_SUMMARY
          echo "4. The app will be installed and ready to use" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **Note**: Apps installed via free Apple ID expire after 7 days and need to be re-signed." >> $GITHUB_STEP_SUMMARY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 13. Comment build result on PR
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment build result
        if: success() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… iOS unsigned build completed successfully!\n\nğŸ“¦ Download the \`ios-unsigned-ipa\` artifact from the [workflow run](${runUrl}).\n\nğŸ“± **This IPA is unsigned** and ready to be re-signed with **SideStore** or **AltStore**.\n\n### Installation Steps:\n1. Download the .ipa file\n2. Transfer to your iOS device\n3. Open in SideStore/AltStore\n4. The app will be re-signed with your free Apple ID and installed\n\nâ° **No paid Apple Developer account needed!** Apps expire after 7 days and need to be re-signed.`
            })

      - name: Comment build failure
        if: failure() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âŒ iOS build failed. Check the [workflow logs](${runUrl}) for details.`
            })
