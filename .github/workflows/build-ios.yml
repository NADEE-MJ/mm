name: Build iOS App

# Trigger on PR comments containing "build ios" or commits to main branch
on:
  issue_comment:
    types: [created]
  push:
    branches:
      - main

jobs:
  build-ios:
    # Run on PR comments containing "build ios" OR pushes to main branch
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'build ios'))
    runs-on: macos-latest

    # Set minimal permissions for security
    permissions:
      contents: read        # Read repository contents
      pull-requests: write  # Comment on PRs
      issues: write         # Add reactions to comments

    steps:
      - name: Add reaction to comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            })

      - name: Get PR branch
        if: github.event_name == 'issue_comment'
        id: pr-branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);

      # Security Note: We checkout the PR branch to build the React Native app.
      # The build happens locally on this runner using Expo prebuild + Xcode.
      # Only maintainers or trusted contributors should trigger this action.
      # Consider adding a check for author association if needed:
      # if: github.event.issue.author_association == 'OWNER' || github.event.issue.author_association == 'MEMBER'
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && steps.pr-branch.outputs.ref || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Install dependencies
        working-directory: mobile
        run: npm ci

      - name: Install Expo CLI
        run: npm install -g expo-cli@latest

      - name: Setup Ruby (for CocoaPods)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Install CocoaPods
        run: sudo gem install cocoapods -v 1.15.2

      - name: Generate native iOS project
        working-directory: mobile
        run: |
          echo "Running expo prebuild to generate native iOS project..."
          echo "Note: Using --clean flag to ensure a fresh build. This removes any existing ios directory."
          npx expo prebuild --platform ios --clean

      - name: Install iOS dependencies
        working-directory: mobile/ios
        run: |
          echo "Installing CocoaPods dependencies..."
          pod install

      - name: Install Fastlane
        run: |
          sudo gem install fastlane -v 2.219.0

      - name: Setup signing with Apple ID
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create a temporary keychain for this build
          security create-keychain -p actions temp.keychain
          security default-keychain -s temp.keychain
          security unlock-keychain -p actions temp.keychain
          security set-keychain-settings -t 3600 -u temp.keychain

          # Create Fastlane Appfile
          mkdir -p mobile/ios/fastlane
          cat > mobile/ios/fastlane/Appfile << EOF
          app_identifier("com.moviemanager.mobile")
          apple_id("$APPLE_ID")
          team_id("$APPLE_TEAM_ID")
          EOF

          # Create Fastlane Matchfile for cert management
          cat > mobile/ios/fastlane/Matchfile << EOF
          git_url("https://github.com/${{ github.repository }}")
          storage_mode("git")
          type("development")
          app_identifier("com.moviemanager.mobile")
          team_id("$APPLE_TEAM_ID")
          EOF

          # Use fastlane to create/download certificates
          cd mobile/ios

          # Set environment variables for fastlane
          export FASTLANE_USER="$APPLE_ID"
          export FASTLANE_PASSWORD="$APPLE_APP_PASSWORD"
          export FASTLANE_DONT_STORE_PASSWORD=1
          export FASTLANE_TEAM_ID="$APPLE_TEAM_ID"

          # Get or create development certificate and provisioning profile
          fastlane run get_certificates \
            development:true \
            username:"$APPLE_ID" \
            team_id:"$APPLE_TEAM_ID" \
            keychain_path:"$HOME/Library/Keychains/temp.keychain-db" \
            keychain_password:"actions"

          fastlane run get_provisioning_profile \
            development:true \
            app_identifier:"com.moviemanager.mobile" \
            username:"$APPLE_ID" \
            team_id:"$APPLE_TEAM_ID" \
            force:true

          echo "‚úÖ Certificates and provisioning profile ready"

      - name: Build iOS app (signed for device)
        working-directory: mobile/ios
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "Building iOS app for device with automatic signing..."

          # Dynamically find the workspace and scheme generated by Expo prebuild
          WORKSPACE=$(ls -d *.xcworkspace | head -1)
          echo "Found workspace: $WORKSPACE"

          # List available schemes so we can pick the right one
          echo "Available schemes:"
          xcodebuild -workspace "$WORKSPACE" -list

          # Get the first scheme name (Expo typically generates one matching the project)
          SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list 2>/dev/null | sed -n '/Schemes:/,/^$/p' | grep -v 'Schemes:' | head -1 | xargs)
          echo "Using scheme: $SCHEME"

          if [ -z "$SCHEME" ]; then
            echo "Error: No scheme found in workspace!"
            exit 1
          fi

          # Ensure xcodebuild failures aren't masked by the tee pipe
          set -o pipefail

          # Build for iOS device with automatic signing
          xcodebuild clean archive \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/MovieManager.xcarchive" \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            | tee build.log

          echo "‚úÖ Build completed. Archive at: $RUNNER_TEMP/MovieManager.xcarchive"

      - name: Export IPA from archive
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "Exporting IPA from archive..."

          # Create export options plist for development distribution
          cat > /tmp/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>development</string>
              <key>teamID</key>
              <string>$APPLE_TEAM_ID</string>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>uploadSymbols</key>
              <false/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF

          # Export the archive to IPA
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/MovieManager.xcarchive" \
            -exportPath "$RUNNER_TEMP/export" \
            -exportOptionsPlist /tmp/ExportOptions.plist \
            -allowProvisioningUpdates

          # Find and move the IPA
          IPA_PATH=$(find "$RUNNER_TEMP/export" -name "*.ipa" -print -quit)

          if [ -z "$IPA_PATH" ]; then
            echo "‚ùå Error: No IPA found in export!"
            ls -R "$RUNNER_TEMP/export"
            exit 1
          fi

          mv "$IPA_PATH" "$GITHUB_WORKSPACE/mobile/app.ipa"

          echo "‚úÖ IPA created successfully at: $GITHUB_WORKSPACE/mobile/app.ipa"
          ls -lh "$GITHUB_WORKSPACE/mobile/app.ipa"

          echo ""
          echo "üì± This IPA is signed for DEVELOPMENT and will run on physical iOS devices."
          echo "‚è∞ Note: Apps signed with a free Apple ID expire after 7 days and need to be rebuilt."

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-development
          path: mobile/app.ipa
          retention-days: 7

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain temp.keychain || true

      - name: Comment build result
        if: success() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ iOS development build completed successfully!\n\nüì¶ Download the IPA from the [workflow artifacts](${runUrl}).\n\nüì± **This IPA is signed for development** and will run on physical iOS devices registered to your Apple Developer account.\n\n‚è∞ **Important**: Apps signed with a free Apple ID expire after 7 days. You'll need to rebuild and reinstall after that period.\n\n**To install**: Use Apple Configurator, Xcode, or a tool like AltStore to install the IPA on your device.`
            })

      - name: Comment build failure
        if: failure() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå iOS build failed. Check the [workflow logs](${runUrl}) for details.`
            })
