name: Build Mobile Swift App (Unsigned)

# Mobile Swift pipeline for Movie Manager app
# xcodegen -> xcodebuild (unsigned) -> IPA artifact -> rolling release (mobile-swift-latest)
#
# Triggers:
#   - workflow_dispatch: manual run from UI, builds IPA + optional release
#   - pull_request: build check on PRs that touch mobile-swift/
#   - push to main: automatically build and release when mobile-swift/ changes
on:
  workflow_dispatch:
    inputs:
      runner_image:
        description: "GitHub macOS runner image"
        required: true
        default: "macos-26"
        type: choice
        options:
          - macos-latest
          - macos-15
          - macos-26
      deployment_target:
        description: "iOS deployment target for build setting (e.g. 26.0)"
        required: true
        default: "26.0"
        type: string
      publish_release:
        description: "Publish/update mobile-swift-latest release"
        required: true
        default: true
        type: boolean
      artifact_suffix:
        description: "Optional suffix for IPA filename (letters, numbers, . _ -)"
        required: false
        default: ""
        type: string

  pull_request:
    branches: [main]
    paths:
      - "mobile-swift/**"
      - ".github/workflows/build-mobile-swift.yml"

  push:
    branches: [main]
    paths:
      - "mobile-swift/**"
      - ".github/workflows/build-mobile-swift.yml"

concurrency:
  group: mobile-swift-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Unsigned Mobile Swift App
    runs-on: ${{ github.event.inputs.runner_image || 'macos-26' }}
    timeout-minutes: 45

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Show Xcode and SDK info
        run: |
          xcodebuild -version
          xcodebuild -showsdks

      - name: Configure API base URL
        env:
          API_BASE_URL: ${{ vars.MOBILE_SWIFT_API_BASE_URL != '' && vars.MOBILE_SWIFT_API_BASE_URL || secrets.MOBILE_SWIFT_API_BASE_URL || '' }}
        run: |
          set -euo pipefail
          if [ -z "$API_BASE_URL" ]; then
            echo "âš ï¸  Missing MOBILE_SWIFT_API_BASE_URL"
            echo "Using default https://localhost:8000/api. Set repository variable or secret MOBILE_SWIFT_API_BASE_URL to configure."
            API_BASE_URL="https://localhost:8000/api"
          fi
          
          echo "API_BASE_URL=$API_BASE_URL" >> "$GITHUB_ENV"
          echo "âœ… API base URL configured: $API_BASE_URL"

      - name: Generate Xcode project
        working-directory: mobile-swift
        run: xcodegen generate

      - name: Resolve SPM dependencies
        working-directory: mobile-swift
        run: |
          xcodebuild -project MobileSwift.xcodeproj \
            -scheme MobileSwift \
            -resolvePackageDependencies

      - name: Build with xcodebuild
        working-directory: mobile-swift
        run: |
          set -euo pipefail

          DEPLOYMENT_TARGET_RAW="${{ github.event.inputs.deployment_target }}"
          DEPLOYMENT_TARGET=$(echo "$DEPLOYMENT_TARGET_RAW" | tr -cd '0-9.')
          if [ -z "$DEPLOYMENT_TARGET" ]; then
            DEPLOYMENT_TARGET="26.0"
          fi
          echo "Using IPHONEOS_DEPLOYMENT_TARGET=$DEPLOYMENT_TARGET"

          set -o pipefail
          xcodebuild \
            -project MobileSwift.xcodeproj \
            -scheme MobileSwift \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build \
            IPHONEOS_DEPLOYMENT_TARGET="$DEPLOYMENT_TARGET" \
            API_BASE_URL="${{ env.API_BASE_URL }}" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            build 2>&1 | tee build.log

          APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" -type d 2>/dev/null | head -1)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ No .app bundle produced"
            find build/Build/Products -maxdepth 3 -type d | sort
            exit 1
          fi

          echo "âœ… Found app bundle: $APP_PATH"
          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"

      - name: Package IPA
        working-directory: mobile-swift
        run: |
          set -euo pipefail

          if [ -z "${{ env.APP_PATH }}" ]; then
            echo "âŒ APP_PATH is empty"
            exit 1
          fi

          rm -rf Payload
          mkdir -p Payload
          cp -R "${{ env.APP_PATH }}" Payload/

          APP_NAME=$(basename "${{ env.APP_PATH }}" .app)

          # Build the IPA filename based on trigger type
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Sanitize branch name for use in filename
            BRANCH_RAW="${{ github.head_ref }}"
            BRANCH=$(echo "$BRANCH_RAW" | tr -cd '[:alnum:]._-' | cut -c1-60)
            IPA_NAME="${APP_NAME}-${BRANCH}-unsigned.ipa"
          else
            SUFFIX_RAW="${{ github.event.inputs.artifact_suffix }}"
            SUFFIX=$(echo "$SUFFIX_RAW" | tr -cd '[:alnum:]._-')
            if [ -n "$SUFFIX" ]; then
              IPA_NAME="${APP_NAME}-${SUFFIX}-unsigned.ipa"
            else
              IPA_NAME="${APP_NAME}-unsigned.ipa"
            fi
          fi

          zip -r -9 "$IPA_NAME" Payload/

          mv "$IPA_NAME" "$GITHUB_WORKSPACE/$IPA_NAME"
          echo "IPA_PATH=$GITHUB_WORKSPACE/$IPA_NAME" >> "$GITHUB_ENV"
          echo "IPA_NAME=$IPA_NAME" >> "$GITHUB_ENV"

          echo "âœ… Created $IPA_NAME"
          du -h "$GITHUB_WORKSPACE/$IPA_NAME"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: mobile-swift-unsigned-ipa
          path: ${{ env.IPA_PATH }}
          retention-days: 30
          if-no-files-found: error

      - name: Publish PR build release
        if: success() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          # Sanitize branch name for tag
          BRANCH_RAW="${{ github.head_ref }}"
          BRANCH=$(echo "$BRANCH_RAW" | tr -cd '[:alnum:]._-' | cut -c1-50)
          
          # Get current date
          DATE=$(date +%Y%m%d-%H%M%S)
          
          TAG="pr-mobile-swift-${BRANCH}-${DATE}"
          RELEASE_TITLE="Mobile Swift PR Build: ${BRANCH}"
          RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases/tag/${TAG}"
          
          # Create tag
          gh api -X POST "repos/${{ github.repository }}/git/refs" \
            -f ref="refs/tags/${TAG}" \
            -f sha="${{ github.sha }}"
          
          NOTES=$(cat <<EOF_NOTES
          PR build for branch \`${BRANCH}\` from commit ${{ github.sha }}.
          
          **Branch:** ${{ github.head_ref }}
          **PR:** #${{ github.event.pull_request.number }}
          **Date:** ${DATE}
          
          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF_NOTES
          )
          
          # Create release
          gh release create "$TAG" "${{ env.IPA_PATH }}#${{ env.IPA_NAME }}" \
            --title "$RELEASE_TITLE" \
            --notes "$NOTES" \
            --prerelease
          
          echo "RELEASE_URL=$RELEASE_URL" >> "$GITHUB_ENV"
          echo "RELEASE_TAG=$TAG" >> "$GITHUB_ENV"
          echo "âœ… Created PR release: $RELEASE_URL"

      - name: Comment on PR with build artifact
        if: success() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IPA_SIZE=$(du -h "${{ env.IPA_PATH }}" | cut -f1)
          
          COMMENT=$(cat <<EOF
          ## âœ… Mobile Swift Build Complete
          
          Your build has finished successfully!
          
          | Property | Value |
          |----------|-------|
          | Branch | \`${{ github.head_ref }}\` |
          | IPA | \`${{ env.IPA_NAME }}\` |
          | Size | ${IPA_SIZE} |
          | Release Tag | \`${{ env.RELEASE_TAG }}\` |
          
          **[ðŸ“¦ Download from Release](${{ env.RELEASE_URL }})**
          
          The IPA is available for download from the release page above. No authentication required!
          EOF
          )
          
          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT"

      - name: Publish latest IPA release
        if: success() && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release == 'true')) && github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          TAG="mobile-swift-latest"
          RELEASE_TITLE="Latest Mobile Swift Build"
          RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases/tag/${TAG}"

          gh api -X PATCH "repos/${{ github.repository }}/git/refs/tags/${TAG}" \
            -f sha="${{ github.sha }}" \
            -F force=true \
            >/dev/null 2>&1 || \
          gh api -X POST "repos/${{ github.repository }}/git/refs" \
            -f ref="refs/tags/${TAG}" \
            -f sha="${{ github.sha }}" \
            >/dev/null

          NOTES=$(cat <<EOF_NOTES
          Automated unsigned Mobile Swift iOS build from commit ${{ github.sha }}.

          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF_NOTES
          )

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release edit "$TAG" --title "$RELEASE_TITLE" --notes "$NOTES" --prerelease
          else
            gh release create "$TAG" --title "$RELEASE_TITLE" --notes "$NOTES" --prerelease
          fi

          gh release upload "$TAG" "${{ env.IPA_PATH }}#${{ env.IPA_NAME }}" --clobber
          echo "RELEASE_URL=$RELEASE_URL" >> "$GITHUB_ENV"
          echo "âœ… Updated rolling release: $RELEASE_URL"

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-swift-build-log
          path: mobile-swift/build.log
          retention-days: 7
          if-no-files-found: warn

      - name: Comment on PR with failure details
        if: failure() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Extract last 50 lines of build log if it exists
          if [ -f mobile-swift/build.log ]; then
            BUILD_LOG_EXCERPT=$(tail -50 mobile-swift/build.log | sed 's/```/`~`/g')
          else
            BUILD_LOG_EXCERPT="Build log not available"
          fi
          
          COMMENT=$(cat <<EOF
          ## âŒ Mobile Swift Build Failed
          
          @copilot The build has failed on this PR. Please investigate and fix the issue.
          
          | Property | Value |
          |----------|-------|
          | Branch | \`${{ github.head_ref }}\` |
          | Workflow | Mobile Swift Build |
          | Commit | \`${{ github.sha }}\` |
          
          **[ðŸ“‹ View Full Logs](${WORKFLOW_URL})**
          
          ### Build Log Excerpt (last 50 lines):
          \`\`\`
          ${BUILD_LOG_EXCERPT}
          \`\`\`
          
          The full build log is available as an artifact on the workflow run page (retained for 7 days).
          EOF
          )
          
          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT"

      - name: Build summary
        if: success() && github.event_name == 'workflow_dispatch'
        run: |
          IPA_SIZE=$(du -h "${{ env.IPA_PATH }}" | cut -f1)
          RELEASE_VALUE="${{ env.RELEASE_URL }}"
          if [ -z "$RELEASE_VALUE" ]; then
            RELEASE_VALUE="not published (publish_release=false or non-main branch)"
          fi

          echo "## Mobile Swift Build Successful" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| IPA | ${{ env.IPA_NAME }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Size | $IPA_SIZE |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact | mobile-swift-unsigned-ipa |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Release | $RELEASE_VALUE |" >> "$GITHUB_STEP_SUMMARY"

      - name: PR check summary
        if: success() && github.event_name == 'pull_request'
        run: |
          IPA_SIZE=$(du -h "${{ env.IPA_PATH }}" | cut -f1)
          echo "## âœ… Mobile Swift Build Passed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Branch | ${{ github.head_ref }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| IPA | ${{ env.IPA_NAME }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Size | $IPA_SIZE |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact | mobile-swift-unsigned-ipa |" >> "$GITHUB_STEP_SUMMARY"

      - name: Push summary
        if: success() && github.event_name == 'push'
        run: |
          IPA_SIZE=$(du -h "${{ env.IPA_PATH }}" | cut -f1)
          echo "## âœ… Mobile Swift Build & Release Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| IPA | ${{ env.IPA_NAME }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Size | $IPA_SIZE |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact | mobile-swift-unsigned-ipa |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Release | ${{ env.RELEASE_URL }} |" >> "$GITHUB_STEP_SUMMARY"
