name: Build iOS (EAS Local)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  issue_comment:
    types: [created]

# Cancel in-progress runs for the same branch
concurrency:
  group: ios-eas-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build with EAS (Local)
    # Run on PR comments containing "build ios" OR pushes to main branch
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'build ios'))
    runs-on: macos-latest
    timeout-minutes: 60

    # Set minimal permissions for security
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Handle PR comment triggers
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Add reaction to comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            })

      - name: Get PR branch
        if: github.event_name == 'issue_comment'
        id: pr-branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Setup
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'issue_comment' && steps.pr-branch.outputs.ref || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: mobile/package-lock.json

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: mobile
        run: npm ci

      - name: Configure Expo environment
        working-directory: mobile
        env:
          MOBILE_ENV_FILE: ${{ vars.MOBILE_ENV_FILE != '' && vars.MOBILE_ENV_FILE || secrets.MOBILE_ENV_FILE || '' }}
          EXPO_PUBLIC_API_URL: ${{ vars.EXPO_PUBLIC_API_URL != '' && vars.EXPO_PUBLIC_API_URL || secrets.EXPO_PUBLIC_API_URL || '' }}
        run: |
          echo "============================================"
          echo "Configuring Expo environment"
          echo "============================================"

          if [ -n "$MOBILE_ENV_FILE" ]; then
            printf '%s\n' "$MOBILE_ENV_FILE" > .env
            echo "‚úÖ Loaded environment from MOBILE_ENV_FILE"
          else
            API_URL="$EXPO_PUBLIC_API_URL"
            if [ -z "$API_URL" ]; then
              API_URL="https://api.moviemanager.com/api"
              echo "‚ö†Ô∏è EXPO_PUBLIC_API_URL not set in GitHub vars/secrets; using production fallback"
            else
              echo "‚úÖ Loaded EXPO_PUBLIC_API_URL from GitHub vars/secrets"
            fi

            {
              echo "# Generated by CI"
              echo "EXPO_PUBLIC_API_URL=$API_URL"
            } > .env
          fi

          if ! grep -q '^EXPO_PUBLIC_API_URL=' .env; then
            echo "‚ùå EXPO_PUBLIC_API_URL is missing in generated .env"
            exit 1
          fi

          echo "‚úÖ EXPO_PUBLIC_API_URL is configured for this build"
          EXPO_PUBLIC_API_URL_VALUE=$(grep '^EXPO_PUBLIC_API_URL=' .env | head -1 | cut -d= -f2-)
          echo "EXPO_PUBLIC_API_URL=$EXPO_PUBLIC_API_URL_VALUE" >> "$GITHUB_ENV"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Generate self-signed credentials
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Generate self-signed iOS credentials
        working-directory: mobile
        run: |
          echo "============================================"
          echo "Creating self-signed credentials (ad-hoc)"
          echo "============================================"

          # Create a self-signed certificate
          openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem \
            -days 365 -nodes -subj "/CN=CI Build"

          # Convert to p12 format (what Xcode/EAS expects)
          openssl pkcs12 -export -out dist_cert.p12 \
            -inkey key.pem -in cert.pem \
            -passout pass:buildpass

          # Create a minimal ad-hoc provisioning profile
          cat > profile.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>AppIDName</key>
              <string>Placeholder</string>
              <key>ApplicationIdentifierPrefix</key>
              <array><string>XXXXXXXXXX</string></array>
              <key>Platform</key>
              <array><string>iOS</string></array>
              <key>Entitlements</key>
              <dict>
                  <key>application-identifier</key>
                  <string>XXXXXXXXXX.*</string>
                  <key>get-task-allow</key>
                  <true/>
              </dict>
              <key>ProvisionsAllDevices</key>
              <true/>
              <key>TeamIdentifier</key>
              <array><string>XXXXXXXXXX</string></array>
              <key>TeamName</key>
              <string>CI Build</string>
              <key>UUID</key>
              <string>00000000-0000-0000-0000-000000000000</string>
              <key>Version</key>
              <integer>1</integer>
          </dict>
          </plist>
          EOF

          # Sign the plist to make it a .mobileprovision file
          openssl smime -sign -in profile.plist -out profile.mobileprovision \
            -signer cert.pem -inkey key.pem -certfile cert.pem \
            -outform der -nodetach

          # Create credentials.json for EAS
          cat > credentials.json << EOF
          {
            "ios": {
              "distributionCertificate": {
                "path": "dist_cert.p12",
                "password": "buildpass"
              },
              "provisioningProfilePath": "profile.mobileprovision"
            }
          }
          EOF

          echo "‚úÖ Self-signed ad-hoc credentials created"
          echo "Note: These are placeholder credentials - SideStore will re-sign with your Apple ID"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Build with EAS
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Build iOS with EAS (local)
        working-directory: mobile
        run: |
          echo "============================================"
          echo "Building iOS app with EAS Build (local)"
          echo "============================================"

          # Build locally with self-signed credentials
          eas build \
            --local \
            --platform ios \
            --profile preview \
            --non-interactive \
            --output ../app.ipa

          echo ""
          echo "‚úÖ Build completed!"
          ls -lh ../app.ipa

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Upload artifact
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-eas
          path: app.ipa
          retention-days: 30
          if-no-files-found: error

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # Build summary
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Build summary
        if: success()
        run: |
          IPA_SIZE=$(du -h app.ipa | cut -f1)

          echo "## ‚úÖ iOS Build Summary (EAS)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Method** | EAS Build (Local) |" >> $GITHUB_STEP_SUMMARY
          echo "| **IPA File** | \`app.ipa\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Size** | $IPA_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| **Profile** | preview (unsigned) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì± Installation" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`ios-ipa-eas\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Install with **SideStore** or **AltStore**" >> $GITHUB_STEP_SUMMARY
          echo "3. The app will be re-signed with your free Apple ID" >> $GITHUB_STEP_SUMMARY

      - name: Comment build result
        if: success() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ iOS build completed with EAS!\n\nüì¶ Download the \`ios-ipa-eas\` artifact from the [workflow run](${runUrl}).\n\nüì± Install with **SideStore** or **AltStore** to sideload on your device.`
            })

      - name: Comment build failure
        if: failure() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå iOS build failed. Check the [workflow logs](${runUrl}) for details.`
            })
