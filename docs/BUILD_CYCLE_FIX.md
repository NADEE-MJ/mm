# Build Cycle Fix - Expo Project Circular Dependency

## ğŸ” The Problem

The build was failing with:

```
error: Cycle inside MovieManager; building could produce unreliable results.
This usually can be resolved by moving the shell script phase '[Expo] Configure project'
so that it runs before the build phase that depends on its outputs.

Cycle details:
â†’ That command depends on command in Target 'MovieManager': script phase "[Expo] Configure project"
```

## ğŸ¯ Root Cause

**Circular Dependency in Build Phases:**

When `expo prebuild` generates the iOS project, it creates build phases in this order:

1. `ExtractAppIntentsMetadata` - Extracts app intents from Swift code
2. `[Expo] Configure project` - Generates ExpoModulesProvider.swift
3. Other build phases

**The Problem:**
- `ExtractAppIntentsMetadata` needs to read Swift files (including ExpoModulesProvider.swift)
- But `ExpoModulesProvider.swift` is **generated by** the `[Expo] Configure project` phase
- So we have a cycle: ExtractAppIntentsMetadata â†’ ExpoModulesProvider.swift â†’ [Expo] Configure project â†’ builds before ExtractAppIntentsMetadata

**Visual Representation:**
```
ExtractAppIntentsMetadata
    â†“ (depends on)
ExpoModulesProvider.swift
    â†“ (generated by)
[Expo] Configure project
    â†“ (runs after? WRONG!)
ExtractAppIntentsMetadata â† CYCLE!
```

## âœ… The Solution

**Reorder the build phases** so `[Expo] Configure project` runs **FIRST**:

```
BEFORE (circular):
1. ExtractAppIntentsMetadata (needs ExpoModulesProvider.swift)
2. [Expo] Configure project (generates ExpoModulesProvider.swift)
3. Other phases

AFTER (fixed):
1. [Expo] Configure project (generates ExpoModulesProvider.swift) â† MOVED TO FIRST
2. ExtractAppIntentsMetadata (reads ExpoModulesProvider.swift)
3. Other phases
```

Now the dependency chain is linear:
```
[Expo] Configure project
    â†“ (generates)
ExpoModulesProvider.swift
    â†“ (used by)
ExtractAppIntentsMetadata
    â†“
Build succeeds! âœ…
```

## ğŸ”§ Implementation

Added to the workflow:

```ruby
# Find the Expo Configure project phase
expo_phase = target.shell_script_build_phases.find do |phase|
  phase.name == '[Expo] Configure project'
end

if expo_phase
  # Remove it from current position
  target.build_phases.delete(expo_phase)
  # Insert it at the beginning (index 0)
  target.build_phases.insert(0, expo_phase)
end
```

This uses the `xcodeproj` gem to:
1. Find the `[Expo] Configure project` build phase
2. Remove it from its current position
3. Insert it at the **very beginning** of the build phases list

## ğŸ“Š Why This Happens

### Expo's Build Phase Order

Expo generates build phases in a specific order based on:
- Which Expo modules are installed
- iOS SDK version
- Xcode version
- React Native version

### When It Breaks

This circular dependency issue appears when:
- âœ… Using newer Xcode versions (16+) with App Intents metadata extraction
- âœ… Using Expo SDK 54+ with ExpoModulesCore
- âœ… Building for iOS 15+ deployment targets

The `ExtractAppIntentsMetadata` phase is a newer Xcode feature that wasn't considered when Expo's prebuild phase ordering was designed.

## ğŸ§ª How to Verify It's Fixed

After the patch runs, the build phases should be ordered like:

```
MovieManager Target Build Phases:
1. [Expo] Configure project          â† Should be FIRST now
2. [CP] Check Pods Manifest.lock
3. Compile Sources
4. Link Binary With Libraries
5. ExtractAppIntentsMetadata          â† Now runs AFTER Expo Configure
6. Embed Frameworks
7. ...
```

## ğŸ”„ Alternative Solutions (Not Used)

### Option 1: Disable App Intents Metadata Extraction
```yaml
- name: Disable App Intents extraction
  run: |
    # Add to build settings
    config.build_settings['SKIP_INSTALL_APP_INTENTS_METADATA'] = 'YES'
```
**Why not**: Loses app intents functionality (Siri shortcuts, etc.)

### Option 2: Update Expo SDK
```bash
npm update expo
```
**Why not**: Requires code changes, may introduce breaking changes

### Option 3: Use Expo EAS Build
```yaml
# Use Expo's managed build service
eas build --platform ios
```
**Why not**: Requires paid Expo account, not as flexible

### Option 4: Manually Fix After Every Prebuild
```bash
# Open Xcode and manually drag build phases
open ios/MovieManager.xcworkspace
```
**Why not**: Not automatable in CI/CD

## ğŸ“ Updated Workflow Step

The "Patch Xcode project" step now does **TWO** things:

1. **Fix Build Cycle** (NEW)
   - Reorders build phases
   - Moves `[Expo] Configure project` to position 0

2. **Disable Code Signing** (EXISTING)
   - Sets `CODE_SIGNING_ALLOWED=NO`
   - Clears signing identity and team

## ğŸ¯ Summary

| Aspect | Details |
|--------|---------|
| **Error** | `Cycle inside MovieManager` |
| **Cause** | Build phase ordering creates circular dependency |
| **Solution** | Move `[Expo] Configure project` phase to beginning |
| **Tool** | `xcodeproj` Ruby gem |
| **When** | After `expo prebuild`, before `xcodebuild` |
| **Impact** | Resolves build failure, no functional changes |

## ğŸš€ Next Build

With this fix applied, the build should now:

1. âœ… Generate iOS project with `expo prebuild`
2. âœ… Reorder build phases to fix cycle
3. âœ… Disable code signing
4. âœ… Build successfully with `xcodebuild`
5. âœ… Create unsigned `.ipa`

---

**This fix is essential for Expo SDK 54+ projects building with Xcode 16+ on macOS runners!** ğŸ‰
