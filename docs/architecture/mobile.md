# Mobile (iOS Swift) Architecture

The iOS app is a native **Swift + SwiftUI** application targeting **iOS 26**. It connects to the same Movie Manager backend as the web frontend and uses a local **GRDB SQLite** database for offline-first data access.

---

## File Structure

```
mobile/
â”œâ”€â”€ project.yml                        # XcodeGen project configuration
â”œâ”€â”€ Config/
â”‚   â”œâ”€â”€ App.xcconfig                   # Build settings (Debug + Release)
â”‚   â””â”€â”€ Env.generated.xcconfig         # Generated from .env (gitignored)
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ generate-env-xcconfig.sh       # Reads .env â†’ generates xcconfig
â”œâ”€â”€ Sources/
â”‚   â”œâ”€â”€ MobileSwiftApp.swift           # App entry point, scene lifecycle
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â”œâ”€â”€ TabItem.swift              # Tab navigation model
â”‚   â”‚   â””â”€â”€ ScrollState.swift          # Scroll position state
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”œâ”€â”€ AuthManager.swift          # JWT auth, Keychain storage, offline handling
â”‚   â”‚   â”œâ”€â”€ NetworkService.swift       # REST API client, movie/person structs
â”‚   â”‚   â”œâ”€â”€ DatabaseManager.swift      # GRDB SQLite, migrations, caching
â”‚   â”‚   â”œâ”€â”€ WebSocketManager.swift     # Real-time sync (WebSocket)
â”‚   â”‚   â”œâ”€â”€ MovieRepository.swift      # Local-first data layer (repository pattern)
â”‚   â”‚   â””â”€â”€ SyncManager.swift          # Pending operation queue, enrichment
â”‚   â”œâ”€â”€ Views/
â”‚   â”‚   â”œâ”€â”€ RootTabHostView.swift      # Tab bar, search button, FAB
â”‚   â”‚   â”œâ”€â”€ Tabs/
â”‚   â”‚   â”‚   â”œâ”€â”€ HomePageView.swift     # Movie list by status
â”‚   â”‚   â”‚   â”œâ”€â”€ ListsPageView.swift    # Custom lists
â”‚   â”‚   â”‚   â”œâ”€â”€ PeoplePageView.swift   # Recommenders + quick recommenders
â”‚   â”‚   â”‚   â”œâ”€â”€ AccountPageView.swift  # Settings, backup, developer tools
â”‚   â”‚   â”‚   â””â”€â”€ ExplorePageView.swift  # TMDB search + add movie
â”‚   â”‚   â”œâ”€â”€ AddMoviePageView.swift     # Full add-movie sheet
â”‚   â”‚   â”œâ”€â”€ GlobalSearchPageView.swift # Cross-tab search
â”‚   â”‚   â””â”€â”€ Components/
â”‚   â”‚       â””â”€â”€ CachedAsyncImage.swift # URLCache-backed image loader
â”‚   â”œâ”€â”€ Theme/
â”‚   â”‚   â””â”€â”€ AppTheme.swift             # Colors, fonts, glass effects
â”‚   â””â”€â”€ Info.plist                     # App config (API URL via build settings)
â””â”€â”€ MobileSwift.xcodeproj              # Generated by XcodeGen (gitignored)
```

---

## Dependencies (Swift Package Manager)

| Package | Version | Purpose |
|---|---|---|
| GRDB.swift | 7.5.0+ | Type-safe SQLite database |
| Nuke | 12.8.0+ | Image loading and disk caching |

Dependencies are declared in `project.yml` and resolved automatically by Xcode / XcodeGen.

---

## Services Layer

### AuthManager

Handles JWT authentication with the backend. Tokens are stored in the **iOS Keychain**.

Key behavior:
- `verifyToken()` calls `GET /api/auth/me` on launch
- If the call returns a **network error** (URLError / no connectivity) â†’ keep session alive, allow offline use
- If the call returns **401/403** â†’ call `logout()`, clear Keychain, force re-login
- This distinction is critical for offline-first: a WiFi outage must not log the user out

### NetworkService

Stateful service (`@Observable`) that owns the in-memory movie and person lists. Handles all HTTP calls to the backend:

- Movie CRUD: fetch, add, update status, mark watched
- People: fetch, add, update, delete
- Search: TMDB search proxied through backend
- Backup: export, import, settings, list, restore

Structs defined here (shared across views):
- `Movie` â€” full movie record including TMDB data, recommendations, watch history
- `Person` â€” recommender with `quick_key`, `color`, `emoji`

### DatabaseManager

Manages the local GRDB SQLite database. Tables:

| Table | Contents |
|---|---|
| `movies` | Cached movie records (imdb_id, title, status, rating, JSON blob) |
| `people` | Cached person records (name, trusted, color, emoji, quick_key) |
| `pending_operations` | Offline write queue (type, payload JSON, retry count) |
| `pending_movies` | Movies added offline that need TMDB enrichment |

**Migrations** are registered with GRDB's `DatabaseMigrator`:
- `v1` â€” Initial schema
- `v2_full_movie_cache` â€” Adds `imdb_id` + `json_data` columns to movies; clears old cache
- `v2_pending_operations` â€” Creates `pending_operations` table
- `v2_pending_movies` â€” Creates `pending_movies` table
- `v3_people_quick_key_color_emoji` â€” Adds `quick_key`, `color`, `emoji` to people

### MovieRepository

The repository layer provides a **local-first data access** API to the views. Views do not call `NetworkService` directly.

Flow for reading movies:
1. Read cached records from GRDB â†’ return immediately to UI
2. Trigger background `syncMovies()` call to fetch latest from API
3. Cache API response back to GRDB
4. Publish updated movie list via `@Observable`

Flow for writing offline:
1. Attempt the network operation
2. If it fails with a network error â†’ store in `pending_operations` queue in GRDB
3. Return a queued result to the UI (UI shows pending indicator)

### SyncManager

Processes the `pending_operations` queue when the app comes online:
- `processPendingOperations()` â€” replays queued actions against the API
- `enrichPendingMovies()` â€” for movies added offline with only a title, searches TMDB and adds the matched movie with a proper TMDB ID
- Retry logic: up to 3 attempts per operation before dropping

### WebSocketManager

Maintains a WebSocket connection for real-time data push from the backend. Reconnects on app foreground and on network changes. Currently wired up; backend WebSocket endpoint required for full functionality.

---

## Image Caching

Movie posters are cached with a custom `URLCache` configuration:

- **Memory**: 100 MB
- **Disk**: 500 MB (path: `movie_images`)
- **Cache policy**: `returnCacheDataElseLoad` â€” serve from cache whenever available
- **Expiration**: 90 days (via `Cache-Control: max-age=7776000` stored with the cached response)

The `CachedAsyncImage` component wraps `URLSession` to check `URLCache.shared` before downloading. All `AsyncImage` usages in movie list views are replaced with `CachedAsyncImage`.

A "Clear Image Cache" button in the Account/Settings view calls `URLCache.shared.removeAllCachedResponses()`.

---

## API Configuration

The API base URL is injected at build time via xcconfig:

1. `Config/App.xcconfig` includes `Config/Env.generated.xcconfig`
2. `Env.generated.xcconfig` is generated by `scripts/generate-env-xcconfig.sh` from `mobile/.env`
3. `Sources/Info.plist` contains `$(API_BASE_URL)` which is expanded at build time
4. `NetworkService` reads the URL from `Bundle.main.infoDictionary`

The app enforces **HTTPS only** (Apple ATS). Development against a local HTTP server requires an ATS exception in `Info.plist` for that IP address.

For CI builds, set the `MOBILE_API_BASE_URL` repository secret. The workflow calls `generate-env-xcconfig.sh` before building.

---

## Project Generation

XcodeGen reads `project.yml` to generate `MobileSwift.xcodeproj`. The generated project file is **gitignored**. Developers must run `xcodegen generate` after cloning.

```bash
brew install xcodegen
cd mobile
./scripts/generate-env-xcconfig.sh  # generates Config/Env.generated.xcconfig
xcodegen generate                   # generates MobileSwift.xcodeproj
open MobileSwift.xcodeproj
```

---

## Tab Navigation

| Tab | View | Purpose |
|---|---|---|
| Home | `HomePageView` | Browse movies by status (To Watch, Watched) |
| Lists | `ListsPageView` | Custom organized movie lists |
| People | `PeoplePageView` | Recommenders; quick recommender filter + badges |
| Account | `AccountPageView` | Settings, backup/export, developer logs |
| Explore | `ExplorePageView` | TMDB movie search and add |

### Expandable Search Bar

The search bar is hidden by default and triggered by a magnifying glass icon in the tab bar â€” between the tab pill and the FAB (+) button.

```
Default:   â”‚  ğŸ   ğŸ‘¥  ğŸ“‹  âš™ï¸    ğŸ”  â•  â”‚
Expanded:  â”‚ ğŸ” Search movies...    âœ•   â”‚  â† above tab bar
           â”‚  ğŸ   ğŸ‘¥  ğŸ“‹  âš™ï¸    âœ•  â•  â”‚
```

Tapping the icon slides the search bar in from the left, auto-focuses the text field, and transforms the icon to an X. Movies filter in real time. Tapping X or switching tabs collapses the bar and clears the text.

Implementation: `SearchState` (`@Observable`) holds `text` and `isExpanded` and is shared via the SwiftUI environment. `RootTabHostView` owns the bar and the icon; `HomePageView` reads `searchState.text` to filter its list.

---

## CI/CD

Workflow: `.github/workflows/build-mobile.yml`

Triggers:
- Push to `main` when `mobile/**` changes
- Pull request when `mobile/**` changes
- Manual dispatch (Actions tab)

Steps:
1. Install XcodeGen
2. Generate xcconfig from `MOBILE_API_BASE_URL` secret
3. Run `xcodegen generate`
4. Resolve SPM dependencies
5. Build unsigned IPA via `xcodebuild`
6. Upload as `mobile-unsigned-ipa` artifact (30-day retention)
7. Publish / update `mobile-latest` release tag (on main push)

See [iOS Build & Distribution](../setup/ios-build.md) for full build and install instructions.

---

## Debug Logging

- Uses `os.Logger` with subsystem `com.moviemanager.mobileswift`
- Account tab includes a **Developer Labs** section with:
  - Verbose logging toggle (Debug builds only)
  - "Test log" button
  - Export logs as `app-debug.log` via share sheet
  - Clear log file
- Log file stored in app's Documents directory; `UIFileSharingEnabled = true` allows access via Finder

---

## Testing Offline Behavior

| Test | Steps | Expected |
|---|---|---|
| Offline launch | Login online â†’ airplane mode â†’ force quit â†’ relaunch | Movie list loads from cache; no login screen |
| Offline data access | Browse online (caches data) â†’ airplane mode â†’ pull to refresh | Cached data shown; no crash |
| Offline write â†’ sync | Go offline â†’ change movie status â†’ restore internet | Queued op syncs on next foreground |
| Auth error vs network error | Airplane mode with valid token | App stays logged in |
| Corrupt token | Manually invalidate stored token | App logs out on next verify |
| First sync after update | Fresh install or DB migration | Old cache cleared; full sync from API |
| Image caching | View posters online â†’ airplane mode â†’ revisit | Posters load instantly from disk cache |

---

## Related Docs

- [People & Recommenders](../features/people.md)
- [Backup & Export](../features/backup-export.md)
- [iOS Build & Distribution](../setup/ios-build.md)
